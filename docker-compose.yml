services:
  # MySQL和Redis已安装在宿主机上，不需要Docker容器
  # 后端服务将连接到宿主机的MySQL和Redis

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: admin-system-backend
    restart: always
    ports:
      - "${SERVER_PORT:-7701}:${SERVER_PORT:-7701}"
    # 从项目根目录的 .env 文件读取环境变量
    env_file:
      - .env
    environment:
      # 连接到宿主机的MySQL和Redis
      # 使用host.docker.internal（如果支持）或宿主机IP
      DB_HOST: ${DB_HOST:-host.docker.internal}
      DB_PORT: ${DB_PORT:-3306}
      DB_USER: ${DB_USER:-root}
      DB_PASSWORD: ${DB_PASSWORD:-root123456}
      DB_NAME: ${DB_NAME:-admin_system}
      DB_CHARSET: ${DB_CHARSET:-utf8mb4}
      REDIS_HOST: ${REDIS_HOST:-host.docker.internal}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_DB: ${REDIS_DB:-0}
      JWT_SECRET: ${JWT_SECRET:-your-secret-key-change-in-production}
      JWT_EXPIRE_HOURS: ${JWT_EXPIRE_HOURS:-72}
      JWT_REFRESH_THRESHOLD_HOURS: ${JWT_REFRESH_THRESHOLD_HOURS:-24}
      SERVER_PORT: ${SERVER_PORT:-7701}
      SERVER_MODE: ${SERVER_MODE:-release}
    # 连接到宿主机的MySQL和Redis
    # 方案1: 使用host.docker.internal (Docker 20.10+)
    extra_hosts:
      - "host.docker.internal:host-gateway"
    # 方案2: 如果host.docker.internal不可用，使用host网络模式（取消下面注释）
    # network_mode: "host"
    # 注意：使用host网络时，需要注释掉上面的ports和extra_hosts
